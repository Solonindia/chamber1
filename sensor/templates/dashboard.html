{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chamber {{ chamber|slice:"2:" }} — Sensor Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

<style>
  :root{
    --ink:#12122d; --muted:#475569; --stroke:#e5e7eb; --card:#ffffff;
    --t0:#ef4444; --t0-bg:#fee2e2; --t1:#f59e0b; --t1-bg:#fef3c7;
    --h0:#3b82f6; --h0-bg:#dbeafe; --h1:#14b8a6; --h1-bg:#ccfbf1;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,sans-serif; color:var(--ink);
       background:linear-gradient(135deg,#7f7fd5 0%,#86a8e7 50%,#91eae4 100%);}

  .navbar{position:sticky; top:0; z-index:10; height:64px; background:#fff; border-bottom:1px solid var(--stroke);
          display:flex; align-items:center; justify-content:space-between; padding:0 16px;}
  .logo{height:40px}
  .nav-right{display:flex; align-items:center; gap:12px}
  .tabs{display:flex; gap:8px; align-items:center}
  .tab{padding:6px 10px; border:1px solid var(--stroke); border-radius:8px; text-decoration:none; color:var(--ink); background:#fff; font-weight:600}
  .tab:hover{background:#f1f5f9}
  .tab.active{background:#0f172a; color:#fff; border-color:#0f172a}
  .nav-link{color:var(--ink); text-decoration:none; font-weight:600; display:flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--stroke); border-radius:8px;}
  .nav-link:hover{background:#f1f5f9}

  .wrap{max-width:1080px; margin:24px auto; padding:0 16px}
  .page-header { display:flex; align-items:center; justify-content:center; gap:16px; margin-bottom:12px; position:relative; }
  .page-title { margin:0; font-size:24px; font-weight:800; letter-spacing:.2px; flex:none; }
  .controls-inline { position:absolute; right:0; top:50%; transform:translateY(-50%); }
  .controls-inline label{font-size:12px; color:var(--muted); font-weight:600}
  select{padding:8px 10px; border:1px solid var(--stroke); border-radius:8px; background:#fff; font-size:14px; outline:none;}
  .btn{appearance:none; border:1px solid var(--stroke); background:#f1f5f9; color:#12122d; height:40px; padding:0 14px;
       border-radius:8px; font-weight:600; cursor:pointer; display:inline-flex; align-items:center; justify-content:center;}
  .btn i{margin-right:6px} .btn:hover{background:#12122d; color:#fff}

  .card{ background:#fff; border:1px solid var(--stroke); border-radius:16px; box-shadow:0 12px 30px rgba(2,6,23,.10);
         width:95%; max-width:2000px; padding:12px 16px 20px; margin:16px auto; }

  .gauges{ display:flex; flex-wrap:wrap; gap:16px; justify-content:center; margin:6px 0 14px; }
  .gcard{ width:240px; background:#fff; border:1px solid var(--stroke); border-radius:14px; padding:10px 12px 16px;
          display:flex; flex-direction:column; align-items:center; gap:8px; box-shadow:0 6px 18px rgba(2,6,23,.06);}
  .gtitle{font-weight:700; font-size:14px; text-align:center}
  .gtitle.t0{color:var(--t0);} .gtitle.t1{color:var(--t1);} .gtitle.h0{color:var(--h0);} .gtitle.h1{color:var(--h1);}

  .gauge-analog{ position:relative; width:200px; height:120px; color:#111; }
  .gauge-analog svg{ width:100%; height:100%; display:block; }
  .arc-bg{ fill:none; stroke:#e5e7eb; stroke-width:14; stroke-linecap:round; }
  .arc-fill{ fill:none; stroke:currentColor; stroke-width:14; stroke-linecap:round; stroke-dasharray:283; stroke-dashoffset:283; }
  .needle{ position:absolute; left:50%; bottom:14px; width:2px; height:78px; background:currentColor; transform-origin:50% 100%;
           transform:rotate(-90deg); border-radius:2px; }
  .hub{ position:absolute; left:50%; bottom:14px; transform:translate(-50%, 50%); width:14px; height:14px; background:#063264; border-radius:50%;
        box-shadow:0 0 0 2px #fff, 0 2px 6px rgba(0,0,0,.25); }

  .t0{color:var(--t0)} .t1{color:var(--t1)} .h0{color:var(--h0)} .h1{color:var(--h1)}
  .gnum{ font-weight:800; margin-top:6px; color:inherit; }

  .table-wrap{ background:#fff; overflow-x:auto; }
  table{ width:100%; min-width:1200px; border-collapse:collapse; font-variant-numeric:tabular-nums; background:#fff; }
  thead th{border:1px solid #070707; height:56px; padding:14px 12px; font-size:15px; font-weight:700; text-align:center;}
  thead .th-t0{background:var(--t0-bg); color:var(--t0);}
  thead .th-t1{background:var(--t1-bg); color:var(--t1);}
  thead .th-h0{background:var(--h0-bg); color:var(--h0);}
  thead .th-h1{background:var(--h1-bg); color:var(--h1);}
  tbody td{background:#fff; padding:12px 14px; border:1px solid #070707; font-size:14px; text-align:center}
  tbody tr:nth-child(even) td{ background:#f7fafc; }
  tbody td.col-t0{color:var(--t0)} tbody td.col-t1{color:var(--t1)} tbody td.col-h0{color:var(--h0)} tbody td.col-h1{color:var(--h1)}
  thead th:last-child, tbody td:last-child{ border-right:1px solid #070707; }

  .gauge-analog .tick-major{ stroke:#94a3b8; stroke-width:2; }
  .gauge-analog .tick-minor{ stroke:#cbd5e1; stroke-width:1; }
  .gauge-analog .tick-label{ fill:#475569; font-size:10px; font-weight:700; }

  .download-panel{ position:fixed; inset:0; display:none; align-items:center; justify-content:center;
                   background:rgba(2,6,23,.45); z-index:20; padding:16px; }
  .download-panel.open{ display:flex; }
  .panel-card{ background:#fff; border:1px solid var(--stroke); border-radius:16px; box-shadow:0 20px 40px rgba(2,6,23,.25);
               padding:20px; width:min(96vw,1100px); }
  .panel-head{ display:flex; align-items:center; justify-content:center; position:relative; padding-bottom:10px; border-bottom:1px dashed #e5e7eb; }
  .panel-title{ margin:0; font-size:18px; font-weight:800; color:#0f172a; display:flex; align-items:center; gap:10px;}
  .icon-btn{ position:absolute; right:8px; top:50%; transform:translateY(-50%); width:36px; height:36px; border-radius:10px;
             border:1px solid #e5e7eb; background:#fff; color:#0f172a; cursor:pointer; }
  .icon-btn:hover{ background:#2054d8; color:#fff; }
  .panel-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px; }
  .field{ display:flex; align-items:center; gap:12px; margin:4px 0; }
  .field label{ flex:0 0 64px; margin:0; white-space:nowrap; font-weight:600; color:#111827; }
  .input-row{ flex:1; display:flex; gap:10px; align-items:center; }
  .input{ padding:10px 12px; border:1px solid #D0D7E2; border-radius:10px; background:#fff; min-width:120px; font-size:14px; }
  .input:focus{ outline:none; border-color:#93c5fd; box-shadow:0 0 0 3px rgba(147,197,253,.35); }
  .panel-actions{ display:flex; justify-content:center; gap:10px; margin-top:2px; }
  .btn-chip{ display:inline-flex; align-items:center; gap:8px; height:40px; padding:0 14px; border-radius:12px;
             font-weight:700; border:1px solid #e5e7eb; background:#f8fafc; color:#0f172a; cursor:pointer;
             transition:transform .08s, box-shadow .12s, background .12s; }
  .btn-chip:hover{ transform:translateY(-1px); box-shadow:0 8px 18px rgba(0,0,0,.12); }
  .btn-primary{ background:#0f172a; color:#fff; border-color:#0f172a; }
  .btn-primary:hover{ background:#111827; }
  .panel-note{ margin:8px 0 0; font-size:12px; line-height:1.4; color:#475569; text-align:center; }
  .panel-note strong{ color:#0f172a; }

  @media (max-width:720px){ .panel-card{ width:calc(100vw - 24px); } .panel-grid{ grid-template-columns:1fr; } }
</style>
</head>
<body>
  <nav class="navbar">
    <img src="{% static 'logo.webp' %}" alt="Logo" class="logo">
    <div class="nav-right">
      <div class="tabs" {% if allowed|length <= 1 %}style="display:none"{% endif %}>
        {% for ch in allowed %}
          <a class="tab {% if chamber == ch %}active{% endif %}"
            href="{% url 'sensor_data_page' ch=ch %}">
            Chamber {{ ch|slice:"2:" }}
          </a>
        {% endfor %}
      </div>
      <a href="{% url 'chart_page' ch=chamber %}" class="nav-link" title="Chart"><i class="fa-solid fa-chart-line"></i><span>Chart</span></a>
    </div>
  </nav>

  <div class="wrap">
    <div class="page-header">
      <h1 class="page-title"><i class="fa fa-microchip"></i> Chamber {{ chamber|slice:"2:" }} — Sensor Data</h1>
      <div class="controls-inline">
       <label for="every">Show Every</label>
        <select id="every">
          <option value="1m" selected>1 minute</option>
          <option value="2m">2 minutes</option>
          <option value="5m">5 minutes</option>
          <option value="10m">10 minutes</option>
          <option value="30m">30 minutes</option>
          <option value="60m">1 hour</option>
          <option value="2h">2 hours</option>
          <option value="3h">3 hours</option>
          <option value="4h">4 hours</option>
          <option value="5h">5 hours</option>
          <option value="6h">6 hours</option>
          <option value="7h">7 hours</option>
          <option value="8h">8 hours</option>
          <option value="9h">9 hours</option>
          <option value="10h">10 hours</option>
          <option value="11h">11 hours</option>
          <option value="12h">12 hours</option>
          <option value="24h">24 hours</option>
        </select>
        <button id="downloadBtn" class="btn"><i class="fa fa-download"></i> Download Data</button>
      </div>
    </div>
  </div>

  <!-- Download panel -->
  <div id="downloadPanel" class="download-panel" aria-hidden="true">
    <div class="panel-card" role="dialog" aria-modal="true" aria-labelledby="dl-title">
      <div class="panel-head">
        <h3 id="dl-title" class="panel-title"><i class="fa-solid fa-download"></i> Download Data</h3>
        <button id="closePanel" class="icon-btn" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <p class="panel-note">
        <strong>Note:</strong> Download respects your <em>Show Every</em> interval.
        E.g., 1 minute → 1-min difference, 10 minutes → 10-min difference.
      </p>
      <div class="panel-grid">
        <div class="field">
          <label>From</label>
          <div class="input-row">
            <input type="date" id="fromDate" class="input">
            <select id="fromHour" class="input"></select>
            <select id="fromMin" class="input"></select>
          </div>
        </div>
        <div class="field">
          <label>To</label>
          <div class="input-row">
            <input type="date" id="toDate" class="input">
            <select id="toHour" class="input"></select>
            <select id="toMin" class="input"></select>
          </div>
        </div>
      </div>
      <div class="panel-actions">
        <button id="btnCsv" class="btn-chip btn-primary"><i class="fa-solid fa-file-csv"></i> Download CSV</button>
        <button id="btnPdf" class="btn-chip"><i class="fa-solid fa-file-pdf"></i> Download PDF</button>
      </div>
    </div>
  </div>

  <div class="card">
    <!-- Gauges -->
    <div class="gauges">
      <div class="gcard">
        <div class="gtitle t0">Temperature (°C)</div>
        <div class="gauge-analog t0">
          <svg id="svg-temperature" viewBox="0 0 200 120">
            <path class="arc-bg" d="M10,110 A90,90 0 0 1 190,110"></path>
            <path id="pf-temperature" class="arc-fill" d="M10,110 A90,90 0 0 1 190,110"></path>
          </svg>
          <div id="n-temperature" class="needle"></div><div class="hub"></div>
        </div>
        <div id="v-temperature" class="gnum t0">--</div>
      </div>

      <div class="gcard">
        <div class="gtitle t1">pressure (°C)</div>
        <div class="gauge-analog t1">
          <svg id="svg-pressure" viewBox="0 0 200 120">
            <path class="arc-bg" d="M10,110 A90,90 0 0 1 190,110"></path>
            <path id="pf-pressure" class="arc-fill" d="M10,110 A90,90 0 0 1 190,110"></path>
          </svg>
          <div id="n-pressure" class="needle"></div><div class="hub"></div>
        </div>
        <div id="v-pressure" class="gnum t1">--</div>
      </div>

      <div class="gcard">
        <div class="gtitle h0">Humidity (%)</div>
        <div class="gauge-analog h0">
          <svg id="svg-humidity" viewBox="0 0 200 120">
            <path class="arc-bg" d="M10,110 A90,90 0 0 1 190,110"></path>
            <path id="pf-humidity" class="arc-fill" d="M10,110 A90,90 0 0 1 190,110"></path>
          </svg>
          <div id="n-humidity" class="needle"></div><div class="hub"></div>
        </div>
        <div id="v-humidity" class="gnum h0">--</div>
      </div>

      <div class="gcard">
        <div class="gtitle h1">co2 (%)</div>
        <div class="gauge-analog h1">
          <svg id="svg-co2" viewBox="0 0 200 120">
            <path class="arc-bg" d="M10,110 A90,90 0 0 1 190,110"></path>
            <path id="pf-co2" class="arc-fill" d="M10,110 A90,90 0 0 1 190,110"></path>
          </svg>
          <div id="n-co2" class="needle"></div><div class="hub"></div>
        </div>
        <div id="v-co2" class="gnum h1">--</div>
      </div>
    </div>

    <!-- Table -->
    <div class="table-wrap">
      <table id="tbl">
        <thead>
          <tr>
            <th>Date</th><th>Time</th>
            <th class="th-t0">Temperature (°C)</th>
            <th class="th-t1">Temperature1 (°C)</th>
            <th class="th-h0">Humidity (%)</th>
            <th class="th-h1">Humidity1 (%)</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>
    </div>
  </div>

<script>
const CH = "{{ chamber }}"; // "ch1" | "ch2" | "ch3"
const tb = document.getElementById('tb');
const everySel = document.getElementById('every');

/* ---------- Table rendering ---------- */
function rowHtml(r){
  return `<tr>
    <td>${r.date}</td>
    <td>${r.time}</td>
    <td class="col-t0">${r.temperature  != null ? Number(r.temperature).toFixed(2) : '--'}</td>
    <td class="col-t1">${r.pressure != null ? Number(r.pressure).toFixed(2) : '--'}</td>
    <td class="col-h0">${r.humidity     != null ? Number(r.humidity).toFixed(2) : '--'}</td>
    <td class="col-h1">${r.co2    != null ? Number(r.co2).toFixed(2) : '--'}</td>
  </tr>`;
}

async function loadTable(){
  const res = await fetch(`/api/range/${CH}/?every=${encodeURIComponent(everySel.value)}`);
  const data = await res.json();
  tb.innerHTML = data.length ? data.map(rowHtml).join('') :
    `<tr><td colspan="6" style="color:#64748b; text-align:center">No rows yet.</td></tr>`;
  if (data.length) updateGauges(data[0]);   // newest row
}
everySel.addEventListener('change', loadTable);

/* ---------- Gauges ---------- */
const LIMITS = {
  temperature:{min:0,max:100}, pressure:{min:0,max:100},
  humidity:{min:0,max:100}, co2:{min:0,max:100},
};
const ARC_LEN = 283;
const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));
function buildTicks(svgId){
  const svg=document.getElementById(svgId); if(!svg) return;
  const NS="http://www.w3.org/2000/svg", cx=100, cy=110, r=90;
  const g=document.createElementNS(NS,'g'); g.setAttribute('aria-hidden','true');
  for(let v=0; v<=100; v+=5){
    const major=(v%10===0), th=Math.PI*(1 - v/100), r2=r, r1=r-(major?10:6);
    const x1=cx+r1*Math.cos(th), y1=cy-r1*Math.sin(th), x2=cx+r2*Math.cos(th), y2=cy-r2*Math.sin(th);
    const line=document.createElementNS(NS,'line');
    line.setAttribute('x1',x1.toFixed(1)); line.setAttribute('y1',y1.toFixed(1));
    line.setAttribute('x2',x2.toFixed(1)); line.setAttribute('y2',y2.toFixed(1));
    line.setAttribute('class', major?'tick-major':'tick-minor'); g.appendChild(line);
    if(major){
      const lx=cx+(r-22)*Math.cos(th), ly=cy-(r-22)*Math.sin(th);
      const txt=document.createElementNS(NS,'text');
      txt.setAttribute('x',lx.toFixed(1)); txt.setAttribute('y',ly.toFixed(1));
      txt.setAttribute('text-anchor','middle'); txt.setAttribute('dominant-baseline','central');
      txt.setAttribute('class','tick-label'); txt.textContent=String(v); g.appendChild(txt);
    }
  }
  svg.insertBefore(g, svg.firstChild);
}
function valueToAngle(key,val){ const {min,max}=LIMITS[key]; const p=clamp((val-min)/(max-min),0,1); return -90+p*180; }
function valueToDash(val,key){ const {min,max}=LIMITS[key]; const p=clamp((val-min)/(max-min),0,1); return ARC_LEN*(1-p); }
function setGauge(key,value){
  const needle=document.getElementById(`n-${key}`), valEl=document.getElementById(`v-${key}`), pf=document.getElementById(`pf-${key}`);
  if(!needle||!valEl) return;
  if(value==null||isNaN(value)){ needle.style.transform=`rotate(-90deg)`; valEl.textContent='--'; if(pf) pf.style.strokeDashoffset=ARC_LEN; return; }
  const ang=valueToAngle(key,value); needle.style.transform=`rotate(${ang}deg)`; valEl.textContent=Number(value).toFixed(2);
  if(pf){ pf.style.strokeDasharray=ARC_LEN; pf.style.strokeDashoffset=valueToDash(value,key); }
}
function updateGauges(latest){
  setGauge('temperature',  latest.temperature);
  setGauge('pressure', latest.pressure);
  setGauge('humidity',     latest.humidity);
  setGauge('co2',    latest.co2);
}
document.addEventListener('DOMContentLoaded', ()=>{
  buildTicks('svg-temperature'); buildTicks('svg-pressure'); buildTicks('svg-humidity'); buildTicks('svg-co2');
});

/* ---------- Refresh cadence ---------- */
loadTable();
setInterval(loadTable, 60000);

/* ---------- Download panel ---------- */
const panel=document.getElementById('downloadPanel');
const openBtn=document.getElementById('downloadBtn');
const closeBtn=document.getElementById('closePanel');
const fromDate=document.getElementById('fromDate');
const toDate=document.getElementById('toDate');
const fromHour=document.getElementById('fromHour');
const toHour=document.getElementById('toHour');
const fromMin=document.getElementById('fromMin');
const toMin=document.getElementById('toMin');
const btnCsv=document.getElementById('btnCsv');
const btnPdf=document.getElementById('btnPdf');

function fillHours(sel){ let html='<option value="">Hour</option>'; for(let h=0;h<=23;h++) html+=`<option value="${String(h).padStart(2,'0')}">${String(h).padStart(2,'0')}</option>`; sel.innerHTML=html; }
function fillMinutes(sel){ let html='<option value="">Min</option>'; for(let m=0;m<60;m++) html+=`<option value="${String(m).padStart(2,'0')}">${String(m).padStart(2,'0')}</option>`; sel.innerHTML=html; }
[fromHour,toHour].forEach(fillHours); [fromMin,toMin].forEach(fillMinutes);

function openPanel(){ [fromDate,toDate,fromHour,toHour,fromMin,toMin].forEach(el=>el.value=''); panel.classList.add('open'); setTimeout(()=>fromDate.focus(),50); }
function closePanel(){ panel.classList.remove('open'); document.body.style.overflow=''; }
openBtn.addEventListener('click', openPanel); closeBtn.addEventListener('click', closePanel);
panel.addEventListener('click', e=>{ if(e.target===panel) closePanel(); });

function buildNaive(date,hour,min){ if(!date||!hour||!min) return ''; return `${date}T${hour}:${min}`; }
function toMillis(naive){ const [d,t]=naive.split('T'); const [Y,M,D]=d.split('-').map(Number); const [h,m]=t.split(':').map(Number); return new Date(Y,M-1,D,h,m).getTime(); }

async function doDownload(kind){
  const start=buildNaive(fromDate.value,fromHour.value,fromMin.value);
  const end=buildNaive(toDate.value,toHour.value,toMin.value);
  const every=everySel.value||'1m';
  if(!start||!end){ alert('Please select complete From and To.'); return; }
  if(toMillis(start)>toMillis(end)){ alert('From must be earlier than To.'); return; }
  const base = kind==='csv' ? 'download_csv' : 'download_pdf';
  const url = `/api/${base}/${CH}/?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}&every=${encodeURIComponent(every)}`;
  try{
    const res=await fetch(url);
    if(!res.ok){ const err=await res.json().catch(()=>({})); alert(err.error||'Data unavailable'); return; }
    const blob=await res.blob(); const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download = kind==='csv' ? `sensor_${CH}.csv` : `sensor_${CH}.pdf`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(a.href); closePanel();
  }catch(e){ alert('Download failed'); }
}
btnCsv.addEventListener('click', ()=>doDownload('csv'));
btnPdf.addEventListener('click', ()=>doDownload('pdf'));
</script>
</body>
</html>
